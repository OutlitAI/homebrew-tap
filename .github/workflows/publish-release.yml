name: Publish Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to mirror (e.g. v0.1.0)"
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download binaries from OutlitAI/outlit-sdk
        env:
          GH_TOKEN: ${{ secrets.OUTLIT_SDK_PAT }}
          VERSION: ${{ inputs.version }}
        run: |
          gh release download "${VERSION}" \
            --repo OutlitAI/outlit-sdk \
            --pattern "outlit-darwin-arm64.tar.gz" \
            --pattern "outlit-darwin-x64.tar.gz" \
            --pattern "outlit-linux-arm64.tar.gz" \
            --pattern "outlit-linux-x64.tar.gz" \
            --dir ./artifacts

      - name: Create public release on this tap repo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
        run: |
          gh release create "${VERSION}" artifacts/*.tar.gz \
            --repo OutlitAI/homebrew-tap \
            --title "outlit ${VERSION}" \
            --notes "Outlit CLI ${VERSION}"

      - name: Compute SHA256 and update formula
        env:
          VERSION: ${{ inputs.version }}
        run: |
          VER="${VERSION#v}"
          SHA_DARWIN_ARM64=$(sha256sum artifacts/outlit-darwin-arm64.tar.gz | awk '{print $1}')
          SHA_DARWIN_X64=$(sha256sum artifacts/outlit-darwin-x64.tar.gz     | awk '{print $1}')
          SHA_LINUX_ARM64=$(sha256sum artifacts/outlit-linux-arm64.tar.gz   | awk '{print $1}')
          SHA_LINUX_X64=$(sha256sum artifacts/outlit-linux-x64.tar.gz       | awk '{print $1}')

          sed \
            -e "s/{{VER}}/${VER}/g" \
            -e "s/{{SHA_DARWIN_ARM64}}/${SHA_DARWIN_ARM64}/" \
            -e "s/{{SHA_DARWIN_X64}}/${SHA_DARWIN_X64}/" \
            -e "s/{{SHA_LINUX_ARM64}}/${SHA_LINUX_ARM64}/" \
            -e "s/{{SHA_LINUX_X64}}/${SHA_LINUX_X64}/" \
            Formula/outlit.rb.tpl > Formula/outlit.rb

      - name: Commit updated formula
        env:
          VERSION: ${{ inputs.version }}
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/outlit.rb
          git diff --cached --quiet && echo "Formula already up to date" && exit 0
          git commit -m "chore: update outlit formula to ${VERSION}"
          git push origin main
